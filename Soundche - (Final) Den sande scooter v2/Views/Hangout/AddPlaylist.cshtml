@model Soundche.Core.Domain.Playlist
@{
    ViewBag.Title = "AddPlaylist";
}

<head>
    <!-- Include Ajax -->
    <script src="https://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>

    <link rel="stylesheet" href="/Views/custom.css" type="text/css" />
</head>

<div>
    <h2>
        Add New Playlist
    </h2>
</div>

<div>
    <!-- This div is essential. Otherwise it doesn't work lmao-->
    @using (@Html.BeginForm())
    {
        @Html.ValidationSummary();
        @Html.TextBoxFor(model => Model.Name, new { @class = "form-control", placeholder = " Playlist name" });
        <button class="btn btn-success" type="submit">Create Playlist</button>

        @using (Html.BeginForm())
        {
            <div id="editorRowsTracks">
                @foreach (var item in Model.Tracks)
                    @Html.Partial("Track", item)
            </div>
            <button id="addNewTrackBtn" type="button">Add New Row</button>
        }
    }
</div>

<!-- READ THE SECOND ONE TO BE SURE https://blog.stevensanderson.com/2010/01/28/validating-a-variable-length-list-aspnet-mvc-2-style/ -->
<!-- Try just adding required to track and having that be shown -->
<!-- TODO ADD THIS, AND THEN MAKE SURE VIDEOS CAN STILL BE PLAYED-->

<!-- All made courtesy to this genius https://stackoverflow.com/questions/29700557/mvc-5-dynamic-rows-with-begincollectionitem -->

<script type="text/javascript">
        $(function () {
            $('#addNewTrackBtn').on('click', function () {
                $.ajax({
                    url: '@Url.Action("Track")',
                        cache: false,
                        success: function (html) { $("#editorRowsTracks").append(html); }
                    });
                    return false;
            });

            $('#editorRowsTracks').on('click', '.deleteRow', function () {
                $(this).closest('.editorRow').remove();
            });

            $('#editorRowsTracks').on('click', '.moveUp', function () {
                $(this).closest('.editorRow').insertBefore($(this).closest('.editorRow').prev());
            });

            $('#editorRowsTracks').on('click', '.moveDown', function () {
                $(this).closest('.editorRow').insertAfter($(this).closest('.editorRow').next());
            });

            $('#editorRowsTracks').on('blur', '#yturl', function (text) {
                ytid = getYoutubeIdFromUrl($(this).val());
                if (ytid != null) {
                    $(this).siblings('#ytid').text(ytid);
                    $(this).siblings('#ytidvalue').val(ytid); // Need this one to actually ensure my value goes over
                    $(this).siblings('#successlabel').text("Modified!");

                    yttitle = loadYtTitleIntoElements(ytid, $(this).siblings('#yttitle'), $(this).siblings('#yttitlevalue'), $(this).siblings('#spinner'));
                }
                else {
                    $(this).siblings('#successlabel').text("Invalid. Value not changed!");
                }
            });
        });

    function loadYtTitleIntoElements(id, tar, spinner) {
        // https://stackoverflow.com/a/39174584/5774018
        var url = 'https://www.youtube.com/watch?v=' + id;
        
        showSpinner(spinner);

        $.getJSON('https://noembed.com/embed',
            { format: 'json', url: url }, function (data) {
                tar.text(data.title);
                hideSpinner(spinner);
            });
    }

    function showSpinner(spinner) {
        //spinner.html('<image src="../Shared/spinner.gif" alt="Loading..." />');
        spinner.show();
    }

    function hideSpinner(spinner) {
        //spinner.html("");
        spinner.hide();
    }

    function getYoutubeIdFromUrl(url) {
        let re = /^(https?:\/\/)?((www\.)?(youtube(-nocookie)?|youtube.googleapis)\.com.*(v\/|v=|vi=|vi\/|e\/|embed\/|user\/.*\/u\/\d+\/)|youtu\.be\/)([_0-9a-z-]+)/i;
        match = String(url).match(re);
        return (match == null) ? null : match[7];
        // Source: https://stackoverflow.com/a/51870158/5774018
        // Regex to get the youtube id from most kinds of youtube links
    }
</script>
